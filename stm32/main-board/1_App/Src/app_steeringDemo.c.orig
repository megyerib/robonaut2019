////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//!
//!  \file      app_steeringDemo.c
//!  \brief     
//!  \details   
//!
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Includes ------------------------------------------------------------------------------------------------------------

#include "app_common.h"
#include "app_steeringDemo.h"
#include "trace.h"
#include "servo.h"
#include "motor.h"
#include "line.h"
#include "bsp_common.h"
#include "bsp_uart.h"
#include "controller.h"
#include "remote.h"

// Defines -------------------------------------------------------------------------------------------------------------

#define STTERINGDEMO_TASK_DELAY 5

// Typedefs ------------------------------------------------------------------------------------------------------------

// Local (static) & extern variables -----------------------------------------------------------------------------------

/*static double p_a;		// m
static double p_meas;	// m
static double e;		// m
static double p;		// m
static double phi_a;	// deg
static double v;		// m/s
static double L;		// m

static double Kp;		//
static double Td;		// sec
static double T;		// sec

uint8_t pwm = 10;

static cFirstOrderTF contrPD;*/

double prev_p;
static double Kd;

// Local (static) function prototypes ----------------------------------------------------------------------------------

static int printInt(int x, uint8_t* buf);

// Global function definitions -----------------------------------------------------------------------------------------

void TaskInit_steeringDemo(void)
{
    servoInit();

    lineInit();

    remoteInit();

<<<<<<< HEAD
=======
	p_a   = 0;
	e 	  = 0;
	p 	  = -0.1;
	phi_a = 0;
	v 	  = 2.5;
	L 	  = 0.275;

	Kp = -4/(v*L);
	Td = 0.001; //0.0217;
	T  = 10*Td;

	contrPD.an_past = 0;
	contrPD.bn_past = 0;
	contrPD.a1 = T;
	contrPD.b0 = Kp;
	contrPD.b1 = Kp*Td;


	Kd = 10;

>>>>>>> da0801dbf91969c4b057c3bbb31d9223cf674917
    xTaskCreate(Task_steeringDemo,
                "TASK_DEMO",
                DEFAULT_STACK_SIZE,
                NULL,
                TASK_SRV_PRIO,
                NULL);
}

float angle;
float line_pos  = 0;
float line_diff = 0;
float prevline = 0;

<<<<<<< HEAD
int actuateEnabled;

int motor_d;
=======
bool enab = true;
int8_t t = 0;

LINE l;
double angle;
int16_t linepos;

uint8_t buf[10];
uint8_t cnt;

void Task_steeringDemo(void* p)
{
	servoSetAngle(0);
>>>>>>> da0801dbf91969c4b057c3bbb31d9223cf674917

float P, D;

<<<<<<< HEAD
void Task_steeringDemo(void* p)
{
=======
	HAL_Delay(2000);

	steerSetAngle(3.1415/180 * 30);



>>>>>>> da0801dbf91969c4b057c3bbb31d9223cf674917
	while(1)
    {
		// REMOTE CONTROL __________________________________

		if (remoteGetState())      // ENABLED
		{
			HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_SET);
			actuateEnabled = 1;
		}
		else                       // DISABLED
		{
			HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_RESET);
			vTaskDelay(STTERINGDEMO_TASK_DELAY);
			actuateEnabled = 0;
		}

		// TRACTION ________________________________________

<<<<<<< HEAD
		motor_d = 12;
=======
		motorSetDutyCycle(10);
		traceBluetooth(BCM_LOG_ENC_VEL, 10);
>>>>>>> da0801dbf91969c4b057c3bbb31d9223cf674917

		// STEERING ________________________________________

		prevline = line_pos;

		line_pos = (float) lineGet().d;

		line_diff = line_pos - prevline;

<<<<<<< HEAD
		P = line_pos  * (1.0 / 90.0f);
=======
		servoSetAngle(angle*2);
>>>>>>> da0801dbf91969c4b057c3bbb31d9223cf674917

		D = line_diff * 1.6f;

<<<<<<< HEAD
		angle = -0.75f * (P + D);

		// ACTUATE _________________________________________
=======

		prev_p = p_meas;

		p_meas = lineGet().d;
		traceBluetooth(BCM_LOG_LINE_D, &p_meas);

		//e = p_a - p_meas;
>>>>>>> da0801dbf91969c4b057c3bbb31d9223cf674917

		if (actuateEnabled)
		{
			motorSetDutyCycle(motor_d);
			servoSetAngle(angle);
		}

<<<<<<< HEAD
		// TRACE ___________________________________________

		//traceBluetooth(BCM_LOG_SERVO_ANGLE, &angle);
		//traceBluetooth(BCM_LOG_LINE_D, &linepos);
		//traceBluetooth(BCM_LOG_ENC_VEL, 10);
=======
		phi_a = -1 * p_meas / 120 * 0.75 + Kd * (prev_p - p_meas);

		servoSetAngle(phi_a);
		traceBluetooth(BCM_LOG_SERVO_ANGLE, &phi_a);
>>>>>>> da0801dbf91969c4b057c3bbb31d9223cf674917

		// END DELAY _______________________________________

		vTaskDelay(STTERINGDEMO_TASK_DELAY);
    }
}

// Local (static) function definitions ---------------------------------------------------------------------------------

static int printInt(int x, uint8_t* buf)
{
	int i = 0;

	if (x < 0)
	{
		buf[0] = '-';
		x *= -1;
		i++;
	}

	buf[i+0] = x / 100 + '0';
	buf[i+1] = (x % 100) / 10 + '0';
	buf[i+2] = (x %  10) + '0';
	buf[i+3] = '\r';
	buf[i+4] = '\n';

	return i + 5;
}
